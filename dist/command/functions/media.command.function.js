"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const media_result_1 = require("../../core/media.result");
const media_handler_1 = require("../../handlers/media.handler");
const response_message_helper_1 = require("../../helpers/response.message.helper");
const sender_1 = require("../../core/sender");
const anime_cache_1 = require("../../core/anime.cache");
class MediaFunction {
    constructor() { }
    async Execute(message, command, dm) {
        await this.Handle(message, command, dm);
    }
    async Handle(message, command, isDM) {
        const color = message.member.highestRole.color;
        anime_cache_1.AnimeCache.Search(command.Parameter)
            .then(results => {
            const ongoing = media_handler_1.MediaHandler.OngoingMedia(results);
            const unreleased = media_handler_1.MediaHandler.UnreleasedMedia(results);
            const unreleasedNoDate = media_handler_1.MediaHandler.UnreleasedNoDateMedia(results);
            const completed = media_handler_1.MediaHandler.CompletedMedia(results);
            const exactMedia = media_handler_1.MediaHandler.ExactMedia(results, command.Parameter);
            if (exactMedia.length > 0) {
                exactMedia.forEach(async (m) => {
                    response_message_helper_1.ResponseMessageHelper.CreateMessage(m, m.status, color).then(response => {
                        media_result_1.MediaResult.SendMessage(message, isDM, response);
                    });
                });
            }
            else if (ongoing.length > 0) {
                if (ongoing.length === 1) {
                    const m = ongoing[0];
                    response_message_helper_1.ResponseMessageHelper.CreateMessage(m, m.status, color).then(response => {
                        media_result_1.MediaResult.SendMessage(message, isDM, response);
                    });
                }
                else {
                    this.SendManyResult(message, command, isDM, ongoing.length, `currently ongoing. Please try to be more specific.`);
                }
            }
            else if (unreleased.length > 0) {
                if (unreleased.length === 1) {
                    const m = unreleased[0];
                    response_message_helper_1.ResponseMessageHelper.CreateMessage(m, m.status, color).then(response => {
                        media_result_1.MediaResult.SendMessage(message, isDM, response);
                    });
                }
                else {
                    this.SendManyResult(message, command, isDM, unreleased.length, `not yet aired. Please try to be more specific.`);
                }
            }
            else if (unreleasedNoDate.length > 0) {
                if (unreleasedNoDate.length === 1) {
                    const m = unreleasedNoDate[0];
                    response_message_helper_1.ResponseMessageHelper.CreateMessage(m, m.status, color).then(response => {
                        media_result_1.MediaResult.SendMessage(message, isDM, response);
                    });
                }
                else {
                    this.SendManyResult(message, command, isDM, unreleasedNoDate.length, `not yet aired. Please try to be more specific.`);
                }
            }
            else if (completed.length > 0) {
                if (completed.length === 1) {
                    completed.forEach(async (m) => {
                        response_message_helper_1.ResponseMessageHelper.CreateMessage(m, m.status, color).then(response => {
                            media_result_1.MediaResult.SendMessage(message, isDM, response);
                        });
                    });
                }
                else {
                    this.SendManyResult(message, command, isDM, completed.length, `already completed.`);
                }
            }
            else {
                sender_1.Sender.SendInfo(message, `Go me nasai!, I didn't find anime that matches your keyword ***"${command.Parameter}"***, try checking your spelling or another keyword.`, isDM);
            }
        })
            .catch(() => {
            sender_1.Sender.SendInfo(message, `Go me nasai!, I didn't find anime that matches your keyword ***"${command.Parameter}"***, try checking your spelling or another keyword.`, isDM);
            console.warn(`Error while searching : [MediaSearch.All(${command.Parameter})]`);
        });
    }
    SendManyResult(message, command, isDM, length, type) {
        sender_1.Sender.SendInfo(message, `I found ***${length}*** anime with your keyword ***${command.Parameter}*** and all of them is ${type}`, isDM);
    }
}
exports.MediaFunction = MediaFunction;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWVkaWEuY29tbWFuZC5mdW5jdGlvbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9jb21tYW5kL2Z1bmN0aW9ucy9tZWRpYS5jb21tYW5kLmZ1bmN0aW9uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBR0EsMERBQXNEO0FBQ3RELGdFQUE0RDtBQUM1RCxtRkFBOEU7QUFFOUUsOENBQTJDO0FBQzNDLHdEQUFvRDtBQUVwRCxNQUFhLGFBQWE7SUFDeEIsZ0JBQWUsQ0FBQztJQUVULEtBQUssQ0FBQyxPQUFPLENBQUMsT0FBaUIsRUFBRSxPQUFrQixFQUFFLEVBQVk7UUFDdEUsTUFBTSxJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sRUFBRSxPQUFPLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFDMUMsQ0FBQztJQUVNLEtBQUssQ0FBQyxNQUFNLENBQUMsT0FBZ0IsRUFBRSxPQUFpQixFQUFFLElBQWE7UUFDcEUsTUFBTSxLQUFLLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQyxXQUFXLENBQUMsS0FBSyxDQUFDO1FBQy9DLHdCQUFVLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUM7YUFDakMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxFQUFFO1lBQ2QsTUFBTSxPQUFPLEdBQUcsNEJBQVksQ0FBQyxZQUFZLENBQUMsT0FBTyxDQUFDLENBQUM7WUFDbkQsTUFBTSxVQUFVLEdBQUcsNEJBQVksQ0FBQyxlQUFlLENBQUMsT0FBTyxDQUFDLENBQUM7WUFDekQsTUFBTSxnQkFBZ0IsR0FBRyw0QkFBWSxDQUFDLHFCQUFxQixDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQ3JFLE1BQU0sU0FBUyxHQUFHLDRCQUFZLENBQUMsY0FBYyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQ3ZELE1BQU0sVUFBVSxHQUFHLDRCQUFZLENBQUMsVUFBVSxDQUFDLE9BQU8sRUFBRSxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUM7WUFFdkUsSUFBSSxVQUFV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QUMsSUFBSSxDQUMxRCxRQUFRLENBQUMsRUFBRTs0QkFDVCwwQkFBVyxDQUFDLFdBQVcsQ0FBQyxPQUFPLEVBQUUsSUFBSSxFQUFFLFFBQVEsQ0FBQyxDQUFDO3dCQUNuRCxDQUFDLENBQ0YsQ0FBQztvQkFDSixDQUFDLENBQUMsQ0FBQztpQkFDSjtxQkFBTTtvQkFDTCxJQUFJLENBQUMsY0FBYyxDQUNqQixPQUFPLEVBQ1AsT0FBTyxFQUNQLElBQUksRUFDSixTQUFTLENBQUMsTUFBTSxFQUNoQixvQkFBb0IsQ0FDckIsQ0FBQztpQkFDSDthQUNGO2lCQUFNO2dCQUNMLGVBQU0sQ0FBQyxRQUFRLENBQ2IsT0FBTyxFQUNQLG1FQUNFLE9BQU8sQ0FBQyxTQUNWLHNEQUFzRCxFQUN0RCxJQUFJLENBQ0wsQ0FBQzthQUNIO1FBQ0gsQ0FBQyxDQUFDO2FBQ0QsS0FBSyxDQUFDLEdBQUcsRUFBRTtZQUNWLGVBQU0sQ0FBQyxRQUFRLENBQ2IsT0FBTyxFQUNQLG1FQUNFLE9BQU8sQ0FBQyxTQUNWLHNEQUFzRCxFQUN0RCxJQUFJLENBQ0wsQ0FBQztZQUNGLE9BQU8sQ0FBQyxJQUFJLENBQ1YsNENBQTRDLE9BQU8sQ0FBQyxTQUFTLElBQUksQ0FDbEUsQ0FBQztRQUNKLENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztJQUVPLGNBQWMsQ0FDcEIsT0FBZ0IsRUFDaEIsT0FBaUIsRUFDakIsSUFBYSxFQUNiLE1BQWMsRUFDZCxJQUFZO1FBRVosZUFBTSxDQUFDLFFBQVEsQ0FDYixPQUFPLEVBQ1AsY0FBYyxNQUFNLGtDQUNsQixPQUFPLENBQUMsU0FDViwwQkFBMEIsSUFBSSxFQUFFLEVBQ2hDLElBQUksQ0FDTCxDQUFDO0lBQ0osQ0FBQztDQUNGO0FBcklELHNDQXFJQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE1lZGlhU2VhcmNoIH0gZnJvbSBcIi4vLi4vLi4vY29yZS9tZWRpYS5zZWFyY2hcIjtcbmltcG9ydCB7IElDb21tYW5kRnVuY3Rpb24gfSBmcm9tIFwiLi4vLi4vaW50ZXJmYWNlcy9jb21tYW5kLmZ1bmN0aW9uLmludGVyZmFjZVwiO1xuaW1wb3J0IHsgSUNvbW1hbmQgfSBmcm9tIFwiLi4vLi4vaW50ZXJmYWNlcy9jb21tYW5kLmludGVyZmFjZVwiO1xuaW1wb3J0IHsgTWVkaWFSZXN1bHQgfSBmcm9tIFwiLi4vLi4vY29yZS9tZWRpYS5yZXN1bHRcIjtcbmltcG9ydCB7IE1lZGlhSGFuZGxlciB9IGZyb20gXCIuLi8uLi9oYW5kbGVycy9tZWRpYS5oYW5kbGVyXCI7XG5pbXBvcnQgeyBSZXNwb25zZU1lc3NhZ2VIZWxwZXIgfSBmcm9tIFwiLi4vLi4vaGVscGVycy9yZXNwb25zZS5tZXNzYWdlLmhlbHBlclwiO1xuaW1wb3J0IHsgTWVzc2FnZSB9IGZyb20gXCJkaXNjb3JkLmpzXCI7XG5pbXBvcnQgeyBTZW5kZXIgfSBmcm9tIFwiLi4vLi4vY29yZS9zZW5kZXJcIjtcbmltcG9ydCB7IEFuaW1lQ2FjaGUgfSBmcm9tIFwiLi4vLi4vY29yZS9hbmltZS5jYWNoZVwiO1xuXG5leHBvcnQgY2xhc3MgTWVkaWFGdW5jdGlvbiBpbXBsZW1lbnRzIElDb21tYW5kRnVuY3Rpb24ge1xuICBjb25zdHJ1Y3RvcigpIHt9XG5cbiAgcHVibGljIGFzeW5jIEV4ZWN1dGUobWVzc2FnZT86IE1lc3NhZ2UsIGNvbW1hbmQ/OiBJQ29tbWFuZCwgZG0/OiBib29sZWFuKSB7XG4gICAgYXdhaXQgdGhpcy5IYW5kbGUobWVzc2FnZSwgY29tbWFuZCwgZG0pO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIEhhbmRsZShtZXNzYWdlOiBNZXNzYWdlLCBjb21tYW5kOiBJQ29tbWFuZCwgaXNETTogYm9vbGVhbikge1xuICAgIGNvbnN0IGNvbG9yID0gbWVzc2FnZS5tZW1iZXIuaGlnaGVzdFJvbGUuY29sb3I7XG4gICAgQW5pbWVDYWNoZS5TZWFyY2goY29tbWFuZC5QYXJhbWV0ZXIpXG4gICAgICAudGhlbihyZXN1bHRzID0+IHtcbiAgICAgICAgY29uc3Qgb25nb2luZyA9IE1lZGlhSGFuZGxlci5PbmdvaW5nTWVkaWEocmVzdWx0cyk7XG4gICAgICAgIGNvbnN0IHVucmVsZWFzZWQgPSBNZWRpYUhhbmRsZXIuVW5yZWxlYXNlZE1lZGlhKHJlc3VsdHMpO1xuICAgICAgICBjb25zdCB1bnJlbGVhc2VkTm9EYXRlID0gTWVkaWFIYW5kbGVyLlVucmVsZWFzZWROb0RhdGVNZWRpYShyZXN1bHRzKTtcbiAgICAgICAgY29uc3QgY29tcGxldGVkID0gTWVkaWFIYW5kbGVyLkNvbXBsZXRlZE1lZGlhKHJlc3VsdHMpO1xuICAgICAgICBjb25zdCBleGFjdE1lZGlhID0gTWVkaWFIYW5kbGVyLkV4YWN0TWVkaWEocmVzdWx0cywgY29tbWFuZC5QYXJhbWV0ZXIpO1xuXG4gICAgICAgIGlmIChleGFjdE1lZGlhLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICBleGFjdE1lZGlhLmZvckVhY2goYXN5bmMgbSA9PiB7XG4gICAgICAgICAgICBSZXNwb25zZU1lc3NhZ2VIZWxwZXIuQ3JlYXRlTWVzc2FnZShtLCBtLnN0YXR1cywgY29sb3IpLnRoZW4oXG4gICAgICAgICAgICAgIHJlc3BvbnNlID0+IHtcbiAgICAgICAgICAgICAgICBNZWRpYVJlc3VsdC5TZW5kTWVzc2FnZShtZXNzYWdlLCBpc0RNLCByZXNwb25zZSk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICk7XG4gICAgICAgICAgfSk7XG4gICAgICAgIH0gZWxzZSBpZiAob25nb2luZy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgaWYgKG9uZ29pbmcubGVuZ3RoID09PSAxKSB7XG4gICAgICAgICAgICBjb25zdCBtID0gb25nb2luZ1swXTtcbiAgICAgICAgICAgIFJlc3BvbnNlTWVzc2FnZUhlbHBlci5DcmVhdGVNZXNzYWdlKG0sIG0uc3RhdHVzLCBjb2xvcikudGhlbihcbiAgICAgICAgICAgICAgcmVzcG9uc2UgPT4ge1xuICAgICAgICAgICAgICAgIE1lZGlhUmVzdWx0LlNlbmRNZXNzYWdlKG1lc3NhZ2UsIGlzRE0sIHJlc3BvbnNlKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5TZW5kTWFueVJlc3VsdChcbiAgICAgICAgICAgICAgbWVzc2FnZSxcbiAgICAgICAgICAgICAgY29tbWFuZCxcbiAgICAgICAgICAgICAgaXNETSxcbiAgICAgICAgICAgICAgb25nb2luZy5sZW5ndGgsXG4gICAgICAgICAgICAgIGBjdXJyZW50bHkgb25nb2luZy4gUGxlYXNlIHRyeSB0byBiZSBtb3JlIHNwZWNpZmljLmBcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2UgaWYgKHVucmVsZWFzZWQubGVuZ3RoID4gMCkge1xuICAgICAgICAgIGlmICh1bnJlbGVhc2VkLmxlbmd0aCA9PT0gMSkge1xuICAgICAgICAgICAgY29uc3QgbSA9IHVucmVsZWFzZWRbMF07XG4gICAgICAgICAgICBSZXNwb25zZU1lc3NhZ2VIZWxwZXIuQ3JlYXRlTWVzc2FnZShtLCBtLnN0YXR1cywgY29sb3IpLnRoZW4oXG4gICAgICAgICAgICAgIHJlc3BvbnNlID0+IHtcbiAgICAgICAgICAgICAgICBNZWRpYVJlc3VsdC5TZW5kTWVzc2FnZShtZXNzYWdlLCBpc0RNLCByZXNwb25zZSk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuU2VuZE1hbnlSZXN1bHQoXG4gICAgICAgICAgICAgIG1lc3NhZ2UsXG4gICAgICAgICAgICAgIGNvbW1hbmQsXG4gICAgICAgICAgICAgIGlzRE0sXG4gICAgICAgICAgICAgIHVucmVsZWFzZWQubGVuZ3RoLFxuICAgICAgICAgICAgICBgbm90IHlldCBhaXJlZC4gUGxlYXNlIHRyeSB0byBiZSBtb3JlIHNwZWNpZmljLmBcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2UgaWYgKHVucmVsZWFzZWROb0RhdGUubGVuZ3RoID4gMCkge1xuICAgICAgICAgIGlmICh1bnJlbGVhc2VkTm9EYXRlLmxlbmd0aCA9PT0gMSkge1xuICAgICAgICAgICAgY29uc3QgbSA9IHVucmVsZWFzZWROb0RhdGVbMF07XG4gICAgICAgICAgICBSZXNwb25zZU1lc3NhZ2VIZWxwZXIuQ3JlYXRlTWVzc2FnZShtLCBtLnN0YXR1cywgY29sb3IpLnRoZW4oXG4gICAgICAgICAgICAgIHJlc3BvbnNlID0+IHtcbiAgICAgICAgICAgICAgICBNZWRpYVJlc3VsdC5TZW5kTWVzc2FnZShtZXNzYWdlLCBpc0RNLCByZXNwb25zZSk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuU2VuZE1hbnlSZXN1bHQoXG4gICAgICAgICAgICAgIG1lc3NhZ2UsXG4gICAgICAgICAgICAgIGNvbW1hbmQsXG4gICAgICAgICAgICAgIGlzRE0sXG4gICAgICAgICAgICAgIHVucmVsZWFzZWROb0RhdGUubGVuZ3RoLFxuICAgICAgICAgICAgICBgbm90IHlldCBhaXJlZC4gUGxlYXNlIHRyeSB0byBiZSBtb3JlIHNwZWNpZmljLmBcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2UgaWYgKGNvbXBsZXRlZC5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgaWYgKGNvbXBsZXRlZC5sZW5ndGggPT09IDEpIHtcbiAgICAgICAgICAgIGNvbXBsZXRlZC5mb3JFYWNoKGFzeW5jIG0gPT4ge1xuICAgICAgICAgICAgICBSZXNwb25zZU1lc3NhZ2VIZWxwZXIuQ3JlYXRlTWVzc2FnZShtLCBtLnN0YXR1cywgY29sb3IpLnRoZW4oXG4gICAgICAgICAgICAgICAgcmVzcG9uc2UgPT4ge1xuICAgICAgICAgICAgICAgICAgTWVkaWFSZXN1bHQuU2VuZE1lc3NhZ2UobWVzc2FnZSwgaXNETSwgcmVzcG9uc2UpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLlNlbmRNYW55UmVzdWx0KFxuICAgICAgICAgICAgICBtZXNzYWdlLFxuICAgICAgICAgICAgICBjb21tYW5kLFxuICAgICAgICAgICAgICBpc0RNLFxuICAgICAgICAgICAgICBjb21wbGV0ZWQubGVuZ3RoLFxuICAgICAgICAgICAgICBgYWxyZWFkeSBjb21wbGV0ZWQuYFxuICAgICAgICAgICAgKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgU2VuZGVyLlNlbmRJbmZvKFxuICAgICAgICAgICAgbWVzc2FnZSxcbiAgICAgICAgICAgIGBHbyBtZSBuYXNhaSEsIEkgZGlkbid0IGZpbmQgYW5pbWUgdGhhdCBtYXRjaGVzIHlvdXIga2V5d29yZCAqKipcIiR7XG4gICAgICAgICAgICAgIGNvbW1hbmQuUGFyYW1ldGVyXG4gICAgICAgICAgICB9XCIqKiosIHRyeSBjaGVja2luZyB5b3VyIHNwZWxsaW5nIG9yIGFub3RoZXIga2V5d29yZC5gLFxuICAgICAgICAgICAgaXNETVxuICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgICAuY2F0Y2goKCkgPT4ge1xuICAgICAgICBTZW5kZXIuU2VuZEluZm8oXG4gICAgICAgICAgbWVzc2FnZSxcbiAgICAgICAgICBgR28gbWUgbmFzYWkhLCBJIGRpZG4ndCBmaW5kIGFuaW1lIHRoYXQgbWF0Y2hlcyB5b3VyIGtleXdvcmQgKioqXCIke1xuICAgICAgICAgICAgY29tbWFuZC5QYXJhbWV0ZXJcbiAgICAgICAgICB9XCIqKiosIHRyeSBjaGVja2luZyB5b3VyIHNwZWxsaW5nIG9yIGFub3RoZXIga2V5d29yZC5gLFxuICAgICAgICAgIGlzRE1cbiAgICAgICAgKTtcbiAgICAgICAgY29uc29sZS53YXJuKFxuICAgICAgICAgIGBFcnJvciB3aGlsZSBzZWFyY2hpbmcgOiBbTWVkaWFTZWFyY2guQWxsKCR7Y29tbWFuZC5QYXJhbWV0ZXJ9KV1gXG4gICAgICAgICk7XG4gICAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgU2VuZE1hbnlSZXN1bHQoXG4gICAgbWVzc2FnZTogTWVzc2FnZSxcbiAgICBjb21tYW5kOiBJQ29tbWFuZCxcbiAgICBpc0RNOiBib29sZWFuLFxuICAgIGxlbmd0aDogbnVtYmVyLFxuICAgIHR5cGU6IHN0cmluZ1xuICApIHtcbiAgICBTZW5kZXIuU2VuZEluZm8oXG4gICAgICBtZXNzYWdlLFxuICAgICAgYEkgZm91bmQgKioqJHtsZW5ndGh9KioqIGFuaW1lIHdpdGggeW91ciBrZXl3b3JkICoqKiR7XG4gICAgICAgIGNvbW1hbmQuUGFyYW1ldGVyXG4gICAgICB9KioqIGFuZCBhbGwgb2YgdGhlbSBpcyAke3R5cGV9YCxcbiAgICAgIGlzRE1cbiAgICApO1xuICB9XG59XG4iXX0=