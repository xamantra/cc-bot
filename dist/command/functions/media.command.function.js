"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const media_result_1 = require("../../core/media.result");
const media_handler_1 = require("../../handlers/media.handler");
const response_message_helper_1 = require("../../helpers/response.message.helper");
const sender_1 = require("../../core/sender");
const anime_cache_1 = require("../../core/anime.cache");
class MediaFunction {
    constructor() { }
    async Execute(message, command, dm) {
        await this.Handle(message, command, dm);
    }
    async Handle(message, command, isDM) {
        const color = message.member.highestRole.color;
        anime_cache_1.AnimeCache.Search(command.Parameter)
            .then(results => {
            const ongoing = media_handler_1.MediaHandler.OngoingMedia(results);
            const unreleased = media_handler_1.MediaHandler.UnreleasedMedia(results);
            const unreleasedNoDate = media_handler_1.MediaHandler.UnreleasedNoDateMedia(results);
            const completed = media_handler_1.MediaHandler.CompletedMedia(results);
            const exactMedia = media_handler_1.MediaHandler.ExactMedia(results, command.Parameter);
            if (exactMedia.length > 0) {
                const m = exactMedia[0];
                response_message_helper_1.ResponseMessageHelper.CreateMessage(m, m.status, color).then(response => {
                    media_result_1.MediaResult.SendMessage(message, isDM, response);
                });
            }
            else if (ongoing.length > 0) {
                if (ongoing.length === 1) {
                    const m = ongoing[0];
                    response_message_helper_1.ResponseMessageHelper.CreateMessage(m, m.status, color).then(response => {
                        media_result_1.MediaResult.SendMessage(message, isDM, response);
                    });
                }
                else {
                    this.SendManyResult(message, command, isDM, ongoing.length, `currently ongoing. Please try to be more specific.`);
                }
            }
            else if (unreleased.length > 0) {
                if (unreleased.length === 1) {
                    const m = unreleased[0];
                    response_message_helper_1.ResponseMessageHelper.CreateMessage(m, m.status, color).then(response => {
                        media_result_1.MediaResult.SendMessage(message, isDM, response);
                    });
                }
                else {
                    this.SendManyResult(message, command, isDM, unreleased.length, `not yet aired. Please try to be more specific.`);
                }
            }
            else if (unreleasedNoDate.length > 0) {
                if (unreleasedNoDate.length === 1) {
                    const m = unreleasedNoDate[0];
                    response_message_helper_1.ResponseMessageHelper.CreateMessage(m, m.status, color).then(response => {
                        media_result_1.MediaResult.SendMessage(message, isDM, response);
                    });
                }
                else {
                    this.SendManyResult(message, command, isDM, unreleasedNoDate.length, `not yet aired. Please try to be more specific.`);
                }
            }
            else if (completed.length > 0) {
                if (completed.length === 1) {
                    completed.forEach(async (m) => {
                        response_message_helper_1.ResponseMessageHelper.CreateMessage(m, m.status, color).then(response => {
                            media_result_1.MediaResult.SendMessage(message, isDM, response);
                        });
                    });
                }
                else {
                    this.SendManyResult(message, command, isDM, completed.length, `already completed.`);
                }
            }
            else {
                sender_1.Sender.SendInfo(message, `Go me nasai!, I didn't find anime that matches your keyword ***"${command.Parameter}"***, try checking your spelling or another keyword.`, isDM);
            }
        })
            .catch(() => {
            sender_1.Sender.SendInfo(message, `Go me nasai!, I didn't find anime that matches your keyword ***"${command.Parameter}"***, try checking your spelling or another keyword.`, isDM);
            console.warn(`Error while searching : [MediaSearch.All(${command.Parameter})]`);
        });
    }
    SendManyResult(message, command, isDM, length, type) {
        sender_1.Sender.SendInfo(message, `I found ***${length}*** anime with your keyword ***${command.Parameter}*** and all of them is ${type}`, isDM);
    }
}
exports.MediaFunction = MediaFunction;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWVkaWEuY29tbWFuZC5mdW5jdGlvbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9jb21tYW5kL2Z1bmN0aW9ucy9tZWRpYS5jb21tYW5kLmZ1bmN0aW9uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBR0EsMERBQXNEO0FBQ3RELGdFQUE0RDtBQUM1RCxtRkFBOEU7QUFFOUUsOENBQTJDO0FBQzNDLHdEQUFvRDtBQUVwRCxNQUFhLGFBQWE7SUFDeEIsZ0JBQWUsQ0FBQztJQUVULEtBQUssQ0FBQyxPQUFPLENBQUMsT0FBaUIsRUFBRSxPQUFrQixFQUFFLEVBQVk7UUFDdEUsTUFBTSxJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sRUFBRSxPQUFPLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFDMUMsQ0FBQztJQUVNLEtBQUssQ0FBQyxNQUFNLENBQUMsT0FBZ0IsRUFBRSxPQUFpQixFQUFFLElBQWE7UUFDcEUsTUFBTSxLQUFLLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQyxXQUFXLENBQUMsS0FBSyxDQUFDO1FBQy9DLHdCQUFVLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUM7YUFDakMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxFQUFFO1lBQ2QsTUFBTSxPQUFPLEdBQUcsNEJBQVksQ0FBQyxZQUFZLENBQUMsT0FBTyxDQUFDLENBQUM7WUFDbkQsTUFBTSxVQUFVLEdBQUcsNEJBQVksQ0FBQyxlQUFlLENBQUMsT0FBTyxDQUFDLENBQUM7WUFDekQsTUFBTSxnQkFBZ0IsR0FBRyw0QkFBWSxDQUFDLHFCQUFxQixDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQ3JFLE1BQU0sU0FBUyxHQUFHLDRCQUFZLENBQUMsY0FBYyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQ3ZELE1BQU0sVUFBVSxHQUFHLDRCQUFZLENBQUMsVUFBVSxDQUFDLE9BQU8sRUFBRSxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUM7WUFFdkUsSUFBSSxVQUFVLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtnQkFDekIsTUFBTSxDQUFDLEdBQUcsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUN4QiwrQ0FBcUIsQ0FBQyxhQUFhLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxNQUFNLEVBQUUsS0FBSyxDQUFDLENBQUMsSUFBSSxDQUMxRCxRQUFRLENBQUMsRUFBRTtvQkFDVCwwQkFBVyxDQUFDLFdBQVcsQ0FBQyxPQUFPLEVBQUUsSUFBSSxFQUFFLFFBQVEsQ0FBQyxDQUFDO2dCQUNuRCxDQUFDLENBQ0YsQ0FBQzthQUNIO2lCQUFNLElBQUksT0FBTyxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7Z0JBQzdCLElBQUksT0FBTyxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUU7b0JBQ3hCLE1BQU0sQ0FBQyxHQUFHLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQztvQkFDckIsK0NBQXFCLENBQUMsYUFBYSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsTUFBTSxFQUFFLEtBQUssQ0FBQyxDQUFDLElBQUksQ0FDMUQsUUFBUSxDQUFDLEVBQUU7d0JBQ1QsMEJBQVcsQ0FBQyxXQUFXLENBQUMsT0FBTyxFQUFFLElBQUksRUFBRSxRQUFRLENBQUMsQ0FBQztvQkFDbkQsQ0FBQyxDQUNGLENBQUM7aUJBQ0g7cUJBQU07b0JBQ0wsSUFBSSxDQUFDLGNBQWMsQ0FDakIsT0FBTyxFQUNQLE9BQU8sRUFDUCxJQUFJLEVBQ0osT0FBTyxDQUFDLE1BQU0sRUFDZCxvREFBb0QsQ0FDckQsQ0FBQztpQkFDSDthQUNGO2lCQUFNLElBQUksVUFBVSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7Z0JBQ2hDLElBQUksVUFBVSxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUU7b0JBQzNCLE1BQU0sQ0FBQyxHQUFHLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQztvQkFDeEIsK0NBQXFCLENBQUMsYUFBYSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsTUFBTSxFQUFFLEtBQUssQ0FBQyxDQUFDLElBQUksQ0FDMUQsUUFBUSxDQUFDLEVBQUU7d0JBQ1QsMEJBQVcsQ0FBQyxXQUFXLENBQUMsT0FBTyxFQUFFLElBQUksRUFBRSxRQUFRLENBQUMsQ0FBQztvQkFDbkQsQ0FBQyxDQUNGLENBQUM7aUJBQ0g7cUJBQU07b0JBQ0wsSUFBSSxDQUFDLGNBQWMsQ0FDakIsT0FBTyxFQUNQLE9BQU8sRUFDUCxJQUFJLEVBQ0osVUFBVSxDQUFDLE1BQU0sRUFDakIsZ0RBQWdELENBQ2pELENBQUM7aUJBQ0g7YUFDRjtpQkFBTSxJQUFJLGdCQUFnQixDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7Z0JBQ3RDLElBQUksZ0JBQWdCLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRTtvQkFDakMsTUFBTSxDQUFDLEdBQUcsZ0JBQWdCLENBQUMsQ0FBQyxDQUFDLENBQUM7b0JBQzlCLCtDQUFxQixDQUFDLGFBQWEsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLE1BQU0sRUFBRSxLQUFLLENBQUMsQ0FBQyxJQUFJLENBQzFELFFBQVEsQ0FBQyxFQUFFO3dCQUNULDBCQUFXLENBQUMsV0FBVyxDQUFDLE9BQU8sRUFBRSxJQUFJLEVBQUUsUUFBUSxDQUFDLENBQUM7b0JBQ25ELENBQUMsQ0FDRixDQUFDO2lCQUNIO3FCQUFNO29CQUNMLElBQUksQ0FBQyxjQUFjLENBQ2pCLE9BQU8sRUFDUCxPQUFPLEVBQ1AsSUFBSSxFQUNKLGdCQUFnQixDQUFDLE1BQU0sRUFDdkIsZ0RBQWdELENBQ2pELENBQUM7aUJBQ0g7YUFDRjtpQkFBTSxJQUFJLFNBQVMsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO2dCQUMvQixJQUFJLFNBQVMsQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFO29CQUMxQixTQUFTLENBQUMsT0FBTyxDQUFDLEtBQUssRUFBQyxDQUFDLEVBQUMsRUFBRTt3QkFDMUIsK0NBQXFCLENBQUMsYUFBYSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsTUFBTSxFQUFFLEtBQUssQ0FBQyxDQUFDLElBQUksQ0FDMUQsUUFBUSxDQUFDLEVBQUU7NEJBQ1QsMEJBQVcsQ0FBQyxXQUFXLENBQUMsT0FBTyxFQUFFLElBQUksRUFBRSxRQUFRLENBQUMsQ0FBQzt3QkFDbkQsQ0FBQyxDQUNGLENBQUM7b0JBQ0osQ0FBQyxDQUFDLENBQUM7aUJBQ0o7cUJBQU07b0JBQ0wsSUFBSSxDQUFDLGNBQWMsQ0FDakIsT0FBTyxFQUNQLE9BQU8sRUFDUCxJQUFJLEVBQ0osU0FBUyxDQUFDLE1BQU0sRUFDaEIsb0JBQW9CLENBQ3JCLENBQUM7aUJBQ0g7YUFDRjtpQkFBTTtnQkFDTCxlQUFNLENBQUMsUUFBUSxDQUNiLE9BQU8sRUFDUCxtRUFDRSxPQUFPLENBQUMsU0FDVixzREFBc0QsRUFDdEQsSUFBSSxDQUNMLENBQUM7YUFDSDtRQUNILENBQUMsQ0FBQzthQUNELEtBQUssQ0FBQyxHQUFHLEVBQUU7WUFDVixlQUFNLENBQUMsUUFBUSxDQUNiLE9BQU8sRUFDUCxtRUFDRSxPQUFPLENBQUMsU0FDVixzREFBc0QsRUFDdEQsSUFBSSxDQUNMLENBQUM7WUFDRixPQUFPLENBQUMsSUFBSSxDQUNWLDRDQUE0QyxPQUFPLENBQUMsU0FBUyxJQUFJLENBQ2xFLENBQUM7UUFDSixDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7SUFFTyxjQUFjLENBQ3BCLE9BQWdCLEVBQ2hCLE9BQWlCLEVBQ2pCLElBQWEsRUFDYixNQUFjLEVBQ2QsSUFBWTtRQUVaLGVBQU0sQ0FBQyxRQUFRLENBQ2IsT0FBTyxFQUNQLGNBQWMsTUFBTSxrQ0FDbEIsT0FBTyxDQUFDLFNBQ1YsMEJBQTBCLElBQUksRUFBRSxFQUNoQyxJQUFJLENBQ0wsQ0FBQztJQUNKLENBQUM7Q0FDRjtBQXBJRCxzQ0FvSUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBNZWRpYVNlYXJjaCB9IGZyb20gXCIuLy4uLy4uL2NvcmUvbWVkaWEuc2VhcmNoXCI7XG5pbXBvcnQgeyBJQ29tbWFuZEZ1bmN0aW9uIH0gZnJvbSBcIi4uLy4uL2ludGVyZmFjZXMvY29tbWFuZC5mdW5jdGlvbi5pbnRlcmZhY2VcIjtcbmltcG9ydCB7IElDb21tYW5kIH0gZnJvbSBcIi4uLy4uL2ludGVyZmFjZXMvY29tbWFuZC5pbnRlcmZhY2VcIjtcbmltcG9ydCB7IE1lZGlhUmVzdWx0IH0gZnJvbSBcIi4uLy4uL2NvcmUvbWVkaWEucmVzdWx0XCI7XG5pbXBvcnQgeyBNZWRpYUhhbmRsZXIgfSBmcm9tIFwiLi4vLi4vaGFuZGxlcnMvbWVkaWEuaGFuZGxlclwiO1xuaW1wb3J0IHsgUmVzcG9uc2VNZXNzYWdlSGVscGVyIH0gZnJvbSBcIi4uLy4uL2hlbHBlcnMvcmVzcG9uc2UubWVzc2FnZS5oZWxwZXJcIjtcbmltcG9ydCB7IE1lc3NhZ2UgfSBmcm9tIFwiZGlzY29yZC5qc1wiO1xuaW1wb3J0IHsgU2VuZGVyIH0gZnJvbSBcIi4uLy4uL2NvcmUvc2VuZGVyXCI7XG5pbXBvcnQgeyBBbmltZUNhY2hlIH0gZnJvbSBcIi4uLy4uL2NvcmUvYW5pbWUuY2FjaGVcIjtcblxuZXhwb3J0IGNsYXNzIE1lZGlhRnVuY3Rpb24gaW1wbGVtZW50cyBJQ29tbWFuZEZ1bmN0aW9uIHtcbiAgY29uc3RydWN0b3IoKSB7fVxuXG4gIHB1YmxpYyBhc3luYyBFeGVjdXRlKG1lc3NhZ2U/OiBNZXNzYWdlLCBjb21tYW5kPzogSUNvbW1hbmQsIGRtPzogYm9vbGVhbikge1xuICAgIGF3YWl0IHRoaXMuSGFuZGxlKG1lc3NhZ2UsIGNvbW1hbmQsIGRtKTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBIYW5kbGUobWVzc2FnZTogTWVzc2FnZSwgY29tbWFuZDogSUNvbW1hbmQsIGlzRE06IGJvb2xlYW4pIHtcbiAgICBjb25zdCBjb2xvciA9IG1lc3NhZ2UubWVtYmVyLmhpZ2hlc3RSb2xlLmNvbG9yO1xuICAgIEFuaW1lQ2FjaGUuU2VhcmNoKGNvbW1hbmQuUGFyYW1ldGVyKVxuICAgICAgLnRoZW4ocmVzdWx0cyA9PiB7XG4gICAgICAgIGNvbnN0IG9uZ29pbmcgPSBNZWRpYUhhbmRsZXIuT25nb2luZ01lZGlhKHJlc3VsdHMpO1xuICAgICAgICBjb25zdCB1bnJlbGVhc2VkID0gTWVkaWFIYW5kbGVyLlVucmVsZWFzZWRNZWRpYShyZXN1bHRzKTtcbiAgICAgICAgY29uc3QgdW5yZWxlYXNlZE5vRGF0ZSA9IE1lZGlhSGFuZGxlci5VbnJlbGVhc2VkTm9EYXRlTWVkaWEocmVzdWx0cyk7XG4gICAgICAgIGNvbnN0IGNvbXBsZXRlZCA9IE1lZGlhSGFuZGxlci5Db21wbGV0ZWRNZWRpYShyZXN1bHRzKTtcbiAgICAgICAgY29uc3QgZXhhY3RNZWRpYSA9IE1lZGlhSGFuZGxlci5FeGFjdE1lZGlhKHJlc3VsdHMsIGNvbW1hbmQuUGFyYW1ldGVyKTtcblxuICAgICAgICBpZiAoZXhhY3RNZWRpYS5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgY29uc3QgbSA9IGV4YWN0TWVkaWFbMF07XG4gICAgICAgICAgUmVzcG9uc2VNZXNzYWdlSGVscGVyLkNyZWF0ZU1lc3NhZ2UobSwgbS5zdGF0dXMsIGNvbG9yKS50aGVuKFxuICAgICAgICAgICAgcmVzcG9uc2UgPT4ge1xuICAgICAgICAgICAgICBNZWRpYVJlc3VsdC5TZW5kTWVzc2FnZShtZXNzYWdlLCBpc0RNLCByZXNwb25zZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgKTtcbiAgICAgICAgfSBlbHNlIGlmIChvbmdvaW5nLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICBpZiAob25nb2luZy5sZW5ndGggPT09IDEpIHtcbiAgICAgICAgICAgIGNvbnN0IG0gPSBvbmdvaW5nWzBdO1xuICAgICAgICAgICAgUmVzcG9uc2VNZXNzYWdlSGVscGVyLkNyZWF0ZU1lc3NhZ2UobSwgbS5zdGF0dXMsIGNvbG9yKS50aGVuKFxuICAgICAgICAgICAgICByZXNwb25zZSA9PiB7XG4gICAgICAgICAgICAgICAgTWVkaWFSZXN1bHQuU2VuZE1lc3NhZ2UobWVzc2FnZSwgaXNETSwgcmVzcG9uc2UpO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICApO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLlNlbmRNYW55UmVzdWx0KFxuICAgICAgICAgICAgICBtZXNzYWdlLFxuICAgICAgICAgICAgICBjb21tYW5kLFxuICAgICAgICAgICAgICBpc0RNLFxuICAgICAgICAgICAgICBvbmdvaW5nLmxlbmd0aCxcbiAgICAgICAgICAgICAgYGN1cnJlbnRseSBvbmdvaW5nLiBQbGVhc2UgdHJ5IHRvIGJlIG1vcmUgc3BlY2lmaWMuYFxuICAgICAgICAgICAgKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSBpZiAodW5yZWxlYXNlZC5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgaWYgKHVucmVsZWFzZWQubGVuZ3RoID09PSAxKSB7XG4gICAgICAgICAgICBjb25zdCBtID0gdW5yZWxlYXNlZFswXTtcbiAgICAgICAgICAgIFJlc3BvbnNlTWVzc2FnZUhlbHBlci5DcmVhdGVNZXNzYWdlKG0sIG0uc3RhdHVzLCBjb2xvcikudGhlbihcbiAgICAgICAgICAgICAgcmVzcG9uc2UgPT4ge1xuICAgICAgICAgICAgICAgIE1lZGlhUmVzdWx0LlNlbmRNZXNzYWdlKG1lc3NhZ2UsIGlzRE0sIHJlc3BvbnNlKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5TZW5kTWFueVJlc3VsdChcbiAgICAgICAgICAgICAgbWVzc2FnZSxcbiAgICAgICAgICAgICAgY29tbWFuZCxcbiAgICAgICAgICAgICAgaXNETSxcbiAgICAgICAgICAgICAgdW5yZWxlYXNlZC5sZW5ndGgsXG4gICAgICAgICAgICAgIGBub3QgeWV0IGFpcmVkLiBQbGVhc2UgdHJ5IHRvIGJlIG1vcmUgc3BlY2lmaWMuYFxuICAgICAgICAgICAgKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSBpZiAodW5yZWxlYXNlZE5vRGF0ZS5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgaWYgKHVucmVsZWFzZWROb0RhdGUubGVuZ3RoID09PSAxKSB7XG4gICAgICAgICAgICBjb25zdCBtID0gdW5yZWxlYXNlZE5vRGF0ZVswXTtcbiAgICAgICAgICAgIFJlc3BvbnNlTWVzc2FnZUhlbHBlci5DcmVhdGVNZXNzYWdlKG0sIG0uc3RhdHVzLCBjb2xvcikudGhlbihcbiAgICAgICAgICAgICAgcmVzcG9uc2UgPT4ge1xuICAgICAgICAgICAgICAgIE1lZGlhUmVzdWx0LlNlbmRNZXNzYWdlKG1lc3NhZ2UsIGlzRE0sIHJlc3BvbnNlKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5TZW5kTWFueVJlc3VsdChcbiAgICAgICAgICAgICAgbWVzc2FnZSxcbiAgICAgICAgICAgICAgY29tbWFuZCxcbiAgICAgICAgICAgICAgaXNETSxcbiAgICAgICAgICAgICAgdW5yZWxlYXNlZE5vRGF0ZS5sZW5ndGgsXG4gICAgICAgICAgICAgIGBub3QgeWV0IGFpcmVkLiBQbGVhc2UgdHJ5IHRvIGJlIG1vcmUgc3BlY2lmaWMuYFxuICAgICAgICAgICAgKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSBpZiAoY29tcGxldGVkLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICBpZiAoY29tcGxldGVkLmxlbmd0aCA9PT0gMSkge1xuICAgICAgICAgICAgY29tcGxldGVkLmZvckVhY2goYXN5bmMgbSA9PiB7XG4gICAgICAgICAgICAgIFJlc3BvbnNlTWVzc2FnZUhlbHBlci5DcmVhdGVNZXNzYWdlKG0sIG0uc3RhdHVzLCBjb2xvcikudGhlbihcbiAgICAgICAgICAgICAgICByZXNwb25zZSA9PiB7XG4gICAgICAgICAgICAgICAgICBNZWRpYVJlc3VsdC5TZW5kTWVzc2FnZShtZXNzYWdlLCBpc0RNLCByZXNwb25zZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuU2VuZE1hbnlSZXN1bHQoXG4gICAgICAgICAgICAgIG1lc3NhZ2UsXG4gICAgICAgICAgICAgIGNvbW1hbmQsXG4gICAgICAgICAgICAgIGlzRE0sXG4gICAgICAgICAgICAgIGNvbXBsZXRlZC5sZW5ndGgsXG4gICAgICAgICAgICAgIGBhbHJlYWR5IGNvbXBsZXRlZC5gXG4gICAgICAgICAgICApO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBTZW5kZXIuU2VuZEluZm8oXG4gICAgICAgICAgICBtZXNzYWdlLFxuICAgICAgICAgICAgYEdvIG1lIG5hc2FpISwgSSBkaWRuJ3QgZmluZCBhbmltZSB0aGF0IG1hdGNoZXMgeW91ciBrZXl3b3JkICoqKlwiJHtcbiAgICAgICAgICAgICAgY29tbWFuZC5QYXJhbWV0ZXJcbiAgICAgICAgICAgIH1cIioqKiwgdHJ5IGNoZWNraW5nIHlvdXIgc3BlbGxpbmcgb3IgYW5vdGhlciBrZXl3b3JkLmAsXG4gICAgICAgICAgICBpc0RNXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgfSlcbiAgICAgIC5jYXRjaCgoKSA9PiB7XG4gICAgICAgIFNlbmRlci5TZW5kSW5mbyhcbiAgICAgICAgICBtZXNzYWdlLFxuICAgICAgICAgIGBHbyBtZSBuYXNhaSEsIEkgZGlkbid0IGZpbmQgYW5pbWUgdGhhdCBtYXRjaGVzIHlvdXIga2V5d29yZCAqKipcIiR7XG4gICAgICAgICAgICBjb21tYW5kLlBhcmFtZXRlclxuICAgICAgICAgIH1cIioqKiwgdHJ5IGNoZWNraW5nIHlvdXIgc3BlbGxpbmcgb3IgYW5vdGhlciBrZXl3b3JkLmAsXG4gICAgICAgICAgaXNETVxuICAgICAgICApO1xuICAgICAgICBjb25zb2xlLndhcm4oXG4gICAgICAgICAgYEVycm9yIHdoaWxlIHNlYXJjaGluZyA6IFtNZWRpYVNlYXJjaC5BbGwoJHtjb21tYW5kLlBhcmFtZXRlcn0pXWBcbiAgICAgICAgKTtcbiAgICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBTZW5kTWFueVJlc3VsdChcbiAgICBtZXNzYWdlOiBNZXNzYWdlLFxuICAgIGNvbW1hbmQ6IElDb21tYW5kLFxuICAgIGlzRE06IGJvb2xlYW4sXG4gICAgbGVuZ3RoOiBudW1iZXIsXG4gICAgdHlwZTogc3RyaW5nXG4gICkge1xuICAgIFNlbmRlci5TZW5kSW5mbyhcbiAgICAgIG1lc3NhZ2UsXG4gICAgICBgSSBmb3VuZCAqKioke2xlbmd0aH0qKiogYW5pbWUgd2l0aCB5b3VyIGtleXdvcmQgKioqJHtcbiAgICAgICAgY29tbWFuZC5QYXJhbWV0ZXJcbiAgICAgIH0qKiogYW5kIGFsbCBvZiB0aGVtIGlzICR7dHlwZX1gLFxuICAgICAgaXNETVxuICAgICk7XG4gIH1cbn1cbiJdfQ==